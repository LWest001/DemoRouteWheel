<!DOCTYPE html>
<html lang='en'>

<head>
    <title>Experiment - on Route </title>
    <style>
        #basic_arena {
            position: relative;
            margin: auto;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            width: 1024px;
            height: 768px;
            display: flex;
            align-items: center;
            /* border: 1px solid grey; */
        }

        #full_arena {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>

    <script src='js_library/jspsych-6.1.0/jspsych.js'></script>
    <script src="js_library/jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <script src='js_library/jspsych-6.1.0/plugins/jspsych-instructions.js'></script>
    <script src='js_library/jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js'></script>
    <script src='js_library/jspsych-6.1.0/plugins/jspsych-html-button-response.js'></script>
    <script src='js_library/jspsych-6.1.0/plugins/jspsych-mouse-reconstruction_leo.js'></script>
    <script src="js_library/underscore-min.js"></script>
    <script src="make_condition_leo.js"></script>
    <link href='js_library/jspsych-6.1.0/css/jspsych.css' rel='stylesheet' type="text/css">
</head>

<body></body>

<script>
    // Add Prolific info recorder Leo 12/22/2021
    // capture info from Prolific
    var subject_id = jsPsych.data.getURLVariable('PROLIFIC_PID');
    var study_id = jsPsych.data.getURLVariable('STUDY_ID');
    var session_id = jsPsych.data.getURLVariable('SESSION_ID');

    // Use when testing outside of cognition.run
    var CONDITION = 6

    jsPsych.data.addProperties({
        subject_id: subject_id,
        study_id: study_id,
        session_id: session_id
    });
    // * image host * //
    // change the host to the parent folder so it can switch sub-folder by Bill 2/10/2022
    var img_host = 'https://raw.githubusercontent.com/YibiaoLiang/onRoute/3-part-pilot/';

    // Add trial counter variable Leo 2/28
    var trialCount = 0;
    var totalTrials = 0;
    var blockNum = 0;
    // add block counter Leo 2/28
    function countBlocks() {
        if (totalTrials > 10 && totalTrials <= 10 + n_bin_onWheel * n_repetition) {
            blockNum = 1
        } else if (totalTrials > 10 + n_bin_onWheel * n_repetition && totalTrials <= 10 + 2 * n_bin_onWheel * n_repetition) {
            blockNum = 2
        } else if (totalTrials > 10 + 2 * n_bin_onWheel * n_repetition) {
            blockNum = 3
        } else {
            blockNum = 0
        }
    }

    // Make practice variable so that practice uses separate route Leo 3/14
    var prac = '00';
    var main = '01';

    // * condition set up * //        
    //change n_bin_onWheel to 12, n_repetition to 4, for 48 trials. Leo 12/22/2021
    var n_bin_onWheel = 12;
    var n_repetition = 4;
    var n_block = 5;
    // add prac_or_main Leo 3/14/22
    var p_mat = make_condition(n_bin_onWheel, n_repetition, img_host, prac);
    var p_mat = p_mat[0].slice(0, 10); // only 10 trials for practicing
    var e_mat = make_condition(n_bin_onWheel, n_repetition, img_host, main);

    //* preload stimuli *//      
    // Set program to preload all stimuli before consent page Leo 3/17/22 
    var images = []
    var folders = ['ISC2/', 'OLM7/', 'JMP3/', 'STB9/']
    for (f = 0; f < folders.length; f++) {
        for (i = 0; i < 361; i++) {
            images.push(
                img_host + folders[f] + ("000000" + i).slice(-6) + '.jpg')
        }
    }

    // create mask_img for preloading Leo 12/21/2021
    var handle_bar = 'stimuli/handle_wheel.png';
    images.push(handle_bar)
    var handle_nobar = 'stimuli/noBar_wheel.png';
    images.push(handle_nobar)
    var mask_img = 'stimuli/mask.png'
    images.push(mask_img)
    var inst_img = [];
    for (i = 1; i <= 7; i++) {
        inst_img.push('stimuli/instruction/Slide' + (i) + '.jpeg');
    }
    images.push(inst_img)


    // ********** displays ********** //
    // * consent form * //
    var consent_page = {
        type: 'html-button-response',
        stimulus: function () {
            var html =
                '<p area-selected="font-size:15px;" class="unselectable"> Press Agree to participate in the experiment.</p>' +
                '<embed src="stimuli/consent_online_credit.pdf" style="width:80vw; height:70vh;"></embed>'
            return html;
        },
        choices: ['Agree'],
        data: {
            disp_type: 'consent_page'
        }

    }

    // * instructions * //
    var general_instruction = {
        type: 'instructions',
        pages: [
            '<img draggable="false" src="' + inst_img[0] + '" style="width:90%">',
            '<img draggable="false" src="' + inst_img[1] + '" style="width:90%">',
            '<img draggable="false" src="' + inst_img[2] + '" style="width:90%">',
            '<img draggable="false" src="' + inst_img[3] + '" style="width:90%">',
            '<img draggable="false" src="' + inst_img[4] + '" style="width:90%">',
            '<img draggable="false" src="' + inst_img[5] + '" style="width:90%">',
            '<img draggable="false" src="' + inst_img[6] + '" style="width:90%">'
        ],
        show_clickable_nav: true,
        show_page_number: true,
        data: {
            disp_type: 'general_instruction'
        }
    }

    // * delayed estimation task * //      
    var fixation = {
        type: 'html-keyboard-response',
        stimulus: html = '<div class="unselectable" id="basic_arena"><div class="unselectable" id="full_arena" style="font-size:24px;">+</div></div>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 1500,
        data: {
            disp_type: 'fixation'
        },
        // increment trial counter for each trial Leo 2/28
        // increment total trial counter for each trial, for block counter Leo 3/4
        on_load: function () {
            trialCount += 1
            totalTrials += 1
            countBlocks()
        }
    }
    var target_display = {
        type: 'html-keyboard-response',
        stimulus: function () {
            var html = '<div class="unselectable" id="basic_arena"><div id="full_arena""><img draggable="false" src="' +
                jsPsych.timelineVariable('img_path', true) + ' "></div></div>';
            return html;
        },
        choices: jsPsych.NO_KEYS,
        trial_duration: 500,
        data: {
            disp_type: 'test_target',
            route: jsPsych.timelineVariable('route')
        }
    }

    //add mask phase to trial Leo 12/21/2021
    var mask = {
        type: 'html-keyboard-response',
        stimulus: html = '<div class="unselectable" id="basic_arena"><div id="full_arena" style="font-size:24px;"><img draggable="false" src="stimuli/mask.png"></img></div></div>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 250,
        data: {
            disp_type: 'mask'
        }
    }
    var adjustment_display = {
        type: 'mouse-reconstruction',
        div_name: 'full_arena',
        starting_value: 360, // grey rectangular (I put grey image as 360.webp in each wheel path)
        wheel_path: jsPsych.timelineVariable('wheel_path'),
        scene_num: jsPsych.timelineVariable('scene_num'),
        image_size: 'height: 256px',
        indicator_path: ['stimuli/noBar_wheel.png', 'stimuli/handle_wheel.png'],
        indicator_size: 'height: 570px',
        wait_fix: 1000,
        trial_duration: 10000,
        data: {
            disp_type: 'test-adjustment',
            route: jsPsych.timelineVariable('route'),
            answer: jsPsych.timelineVariable('scene_num')
        }
    }

    // ******* timeline components ******* // 
    // practice  
    // add mask to timeline for practice and main Leo 12/21/2021
    var memory_prac = {
        timeline: [fixation, target_display, mask, adjustment_display],
        timeline_variables: p_mat,
        randomize_order: true
    }

    // prac2main
    var prac2main = {
        type: 'html-button-response',
        stimulus: html = '<p class="unselectable" style="color: black; font-size: 20px;">' +
            'Practice trials are done!</br>' +
            'Click the <i>Start</i> button to start the main experiment.</br></br>' +
            //Change to say 144 trials with breaks every 48 trials for the pilot Leo Westebbe 12/17/2021
            'The main experiment consists of ' + (n_bin_onWheel * n_repetition * (n_block - 2)) + ' trials.</br>' +
            'There will be a short break every ' + (n_bin_onWheel * n_repetition) + ' trials.',
        choices: ['Start'],
        data: {
            disp_type: 'start-mainExp'
        },
        on_finish: function () {
            trialCount = 0
        }
    }

    // main        
    for (b = 0; b < n_block; b++) {
        this['memory_main' + (b + 1)] = {
            timeline: [fixation, target_display, mask, adjustment_display],
            timeline_variables: e_mat[b],
            randomize_order: true
        }
    }
    //add Clock for break and adjust break language 12/23/2021
    /* change for condition to n_block - 2 to accomodate final block
    create if statement for 2 types of main_block_end screens*/
    for (b = 0; b < n_block - 2; b++) {
        if (b < 2) {
            this['main_block_end' + (b + 1)] = {
                type: 'html-button-response',
                stimulus: '<div class="unselectable" style="font-size:20px;">Block ' + (b + 1) + ' is done!<br><br>' +
                    'After a 1 minute break, you may press the button to proceed.' +
                    'Please do not take a break longer than 3 minutes.</div>' +
                    '<div class="unselectable" style="font-size:20px;" id="clock"></div>' +
                    '<div class="unselectable" style="font-size:20px;color:red;" id="breakPrompt"></div>',
                choices: ['Proceed'],
                //timer loads with this screen Leo 12/23/2021
                on_load: function () {
                    var wait_time = 01 * 60 * 1000; // in milliseconds
                    var start_time = performance.now();
                    document.querySelector('button').disabled = true;
                    var interval = setInterval(function () {
                        var time_left = wait_time - (performance.now() - start_time);
                        var minutes = Math.floor(time_left / 1000 / 60);
                        var seconds = Math.floor((time_left - minutes * 1000 * 60) / 1000);
                        var seconds_str = seconds.toString().padStart(2, '0');
                        document.querySelector('#clock').innerHTML = minutes + ':' + seconds_str
                        if (time_left <= 0) {
                            document.querySelector('#clock').innerHTML = "0:00";
                            document.querySelector('button').disabled = false;
                            document.getElementById("clock").style.color = "red";
                            document.getElementById("breakPrompt").innerHTML = "Please press the button now to proceed to the next block.";
                            clearInterval(interval);
                        }
                    }, 250)
                },
                data: {
                    disp_type: 'prac_block_done'
                },
                // Reset trial counter Leo 3/1
                on_finish: function () {
                    trialCount = 0
                }
            }
            // move final main_block_end inside of if statement
        } else {
            this['main_block_end' + (b + 1)] = {
                type: 'html-button-response',
                stimulus: '<div class="unselectable" style="font-size:20px;">Block ' + (b + 1) + ' is done!<br><br>' +
                    'Press the button to save data and move on to the end of the experiment.<br></div>',
                choices: ['Save data'],
                data: {
                    disp_type: 'prac_block_done'
                },
                // Reset trial counter Leo 3/1
                on_finish: function () {
                    trialCount = 0
                }
            }
        }
    };

    // * save data * //
    var save_data = {
        type: 'html-keyboard-response',
        stimulus: '<p>We are saving your data, please stay on this page.</p>',
        choices: jsPsych.NO_KEYS,
        trial_duration: 3000,
        data: { // create confirmation code with data saving
            conf_code: Math.floor(1000 + Math.random() * 9000)
        },
        on_finish: function () {
            // get data values
            var data = {
                experiment: "sceneWheel_categoryLearning_200ms",
                repo: "sceneWheel_categoryLearning_200ms",
                data: jsPsych.data.get().values(),
                interaction_data: jsPsych.data.getInteractionData().values(),
                exp_condition: e_mat,
                current_url: window.location.href
            }

            // send data to savejs
            var xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://macklab-savejs.netlify.app/api/savejs');
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onload = function () {
                if (xhr.status == 200) {
                    var response = JSON.parse(xhr.responseText);
                    
                }
            };
            xhr.send(JSON.stringify(data));
        }
    }

    // demographic page
    var demographic_page = {
        type: 'html-button-response',
        //remove demographic page Leo Westebbe 12/17/2021
        stimulus: html = '<p style="color: black; font-size: 20px;">' +
            'To finish this experiment, press the button below.<br>' +
            'You will be directed back to Prolific. </p>',
        //'You are done! Now we would like to collect your demographic information.</br>' +
        //'Click the <b>Demographic questions</b> below to complete the form.</br>' +
        //'After submitting the form, come back to this page and check out the debriefing letter!</br></br>' +
        //'<a href="https://redcap.utoronto.ca/surveys/index.php?s=DDT8ME9KFL&study_name=scene_wheel_category_learning_200ms" target="_blank">' +
        //'Demographic questions </a></br></br></p>',
        choices: ['Go back to Prolific.'],
        data: {
            disp_type: 'demographic-link'
        }
    }

    // debriefing letter
    var debrief_page = {
        type: 'html-keyboard-response',
        stimulus: function () {
            var html =
                '<p area-selected="font-size:15px;"> Thank you for participating! </br> Once checking the defriefing letter and questions, you can leave this page.</p>' +
                '<embed src="stimuli/debriefing.pdf" style="width:80vw; height:70vh;"></embed>'
            return html;
        },
        choices: jsPsych.NO_KEYS,
        data: {
            disp_type: 'debriefing_page'
        }
    }

    // ********** timeline fill up ********** // 
    timeline = [];
    // timeline.push(consent_page);
    timeline.push({
        type: 'fullscreen',
        fullscreen_mode: true
    });
    timeline.push(general_instruction);
    timeline.push(memory_prac);
    timeline.push(prac2main);
    //change block counter to b<3 so there are 3 blocks Leo 12/22/2021
    for (b = 0; b < 3; b++) {
        timeline.push(eval('memory_main' + (b + 1)));
        timeline.push(eval('main_block_end' + (b + 1)));
    }
    timeline.push(save_data);
    timeline.push(demographic_page);
    //end fullscreen after demographic page
    timeline.push({
        type: 'fullscreen',
        fullscreen_mode: false
    });
    //Comment out debrief page Leo Westebbe 12/17/2021
    //timeline.push(debrief_page);
    //timeline.push({
    //    type: 'fullscreen',
    //    fullscreen_mode: false
    //});

    // ****** Start ***** //
    // add mask_img to preload_images Leo 12/21/2021
    // Add auto-redirect on finish to Prolific completion URL Leo 12/22/2021
    // change preload property to just 'images' variable Leo 3/17
    jsPsych.init({
        timeline: timeline,
        preload_images: images,
        on_finish: function () {
            window.location = "https://app.prolific.co/submissions/complete?cc=106F945D"
        }
    });
</script>

</html>